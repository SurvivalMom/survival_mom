<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ff6b9d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ã“ã“ã‚ãƒã‚¹ã‚¿ãƒ¼ã‚º ğŸŒˆ</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap" rel="stylesheet">

  <!-- React & Babel -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.25.6/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>

  <style>
    :root {
      --pink:    #ff6b9d;
      --orange:  #ff9f43;
      --yellow:  #ffd32a;
      --mint:    #48dbfb;
      --purple:  #a29bfe;
      --navy:    #1a1a2e;
      --card-bg: rgba(255,255,255,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'M PLUS Rounded 1c', 'Zen Maru Gothic', sans-serif;
      background: var(--navy);
      overflow-x: hidden;
      position: relative;
    }

    /* â”€â”€ èƒŒæ™¯ã®æ˜Ÿãƒ»æ³¡ã‚¢ãƒ‹ãƒ¡ â”€â”€ */
    .bg-canvas {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      overflow: hidden;
    }
    .star {
      position: absolute; border-radius: 50%;
      background: white; opacity: 0;
      animation: twinkle var(--d, 3s) var(--delay, 0s) infinite;
    }
    @keyframes twinkle {
      0%,100% { opacity:0; transform:scale(0.5); }
      50%      { opacity:0.7; transform:scale(1); }
    }
    .bubble {
      position: absolute; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent);
      border: 2px solid rgba(255,255,255,0.15);
      animation: rise var(--d, 8s) var(--delay, 0s) infinite;
      bottom: -80px; opacity: 0;
    }
    @keyframes rise {
      0%   { transform: translateX(0) translateY(0); opacity:0; }
      10%  { opacity: 0.6; }
      90%  { opacity: 0.3; }
      100% { transform: translateX(var(--drift,30px)) translateY(-110vh); opacity:0; }
    }

    #root {
      position: relative; z-index: 1;
    }

    /* â”€â”€ ã‚«ãƒ¼ãƒ‰ â”€â”€ */
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 2px solid rgba(255,255,255,0.18);
      border-radius: 32px;
    }
    .card-glow-pink   { box-shadow: 0 0 40px rgba(255,107,157,0.25), 0 20px 60px rgba(0,0,0,0.4); }
    .card-glow-blue   { box-shadow: 0 0 40px rgba(72,219,251,0.25), 0 20px 60px rgba(0,0,0,0.4); }
    .card-glow-yellow { box-shadow: 0 0 40px rgba(255,211,42,0.3), 0 20px 60px rgba(0,0,0,0.4); }

    /* â”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒœã‚¿ãƒ³ â”€â”€ */
    .user-btn {
      position: relative; border: none; cursor: pointer; color: white;
      border-radius: 28px; font-family: inherit; font-weight: 900;
      transition: transform 0.15s, box-shadow 0.15s;
      overflow: hidden;
    }
    .user-btn::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.25) 0%, transparent 100%);
      border-radius: 28px;
    }
    .user-btn:active { transform: translateY(5px); box-shadow: 0 2px 0 rgba(0,0,0,0.4) !important; }
    .user-btn-mama {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      box-shadow: 0 8px 0 #8b1a3a, 0 12px 30px rgba(255,107,157,0.4);
    }
    .user-btn-child1 {
      background: linear-gradient(135deg, #48dbfb, #0984e3);
      box-shadow: 0 8px 0 #055799, 0 12px 30px rgba(72,219,251,0.4);
    }
    .user-btn-child2 {
      background: linear-gradient(135deg, #55efc4, #00b894);
      box-shadow: 0 8px 0 #007a60, 0 12px 30px rgba(85,239,196,0.4);
    }

    /* â”€â”€ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ â”€â”€ */
    .monster-card {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 24px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    .monster-card:hover {
      transform: translateY(-8px) scale(1.03);
      border-color: rgba(255,255,255,0.4);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    /* â”€â”€ ã‚³ãƒ¼ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ â”€â”€ */
    .coping-card {
      background: rgba(255,255,255,0.08);
      border: 3px solid rgba(255,255,255,0.15);
      border-radius: 20px; cursor: pointer;
      transition: transform 0.15s, background 0.15s, border-color 0.15s;
    }
    .coping-card:hover { background: rgba(255,255,255,0.18); border-color: var(--yellow); transform: scale(1.05); }
    .coping-card:active { transform: scale(0.95); }

    /* â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å…¨ç”»é¢ â”€â”€ */
    .action-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: radial-gradient(ellipse at center, #1a1a4e 0%, #0d0d2b 100%);
      display: flex; align-items: center; justify-content: center; padding: 24px;
    }

    /* â”€â”€ æ¸©åº¦è¨ˆ â”€â”€ */
    .thermo-tube {
      width: 56px; height: 260px;
      background: rgba(0,0,0,0.45);
      border: 4px solid rgba(255,255,255,0.25);
      border-radius: 50px; position: relative; overflow: hidden;
    }
    .thermo-fill {
      position: absolute; bottom: 0; width: 100%;
      border-radius: 50px; transition: height 0.8s cubic-bezier(.4,0,.2,1);
    }

    /* â”€â”€ ã‚¢ãƒ‹ãƒ¡ â”€â”€ */
    @keyframes float-y { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-18px)} }
    @keyframes spin-once { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    @keyframes pop-in {
      0%   {transform:scale(0) rotate(-10deg); opacity:0}
      70%  {transform:scale(1.1) rotate(3deg); opacity:1}
      100% {transform:scale(1) rotate(0deg); opacity:1}
    }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 60%{transform:translateX(8px)} }
    @keyframes confetti-fall {
      0%   { transform:translateY(-20px) rotate(0); opacity:1; }
      100% { transform:translateY(100vh) rotate(720deg); opacity:0; }
    }
    .anim-float { animation: float-y 3s ease-in-out infinite; }
    .anim-pop   { animation: pop-in 0.5s cubic-bezier(.4,0,.2,1) forwards; }
    .anim-shake { animation: shake 0.4s; }

    /* â”€â”€ AIãƒãƒ–ãƒ« â”€â”€ */
    .ai-bubble {
      background: linear-gradient(135deg, rgba(162,155,254,0.2), rgba(72,219,251,0.15));
      border: 2px solid rgba(162,155,254,0.45);
      border-radius: 20px; padding: 16px 20px;
      position: relative;
    }
    .ai-bubble::before {
      content: ''; position: absolute; top: -10px; left: 24px;
      border: 10px solid transparent;
      border-bottom-color: rgba(162,155,254,0.45);
      border-top: 0;
    }

    /* â”€â”€ çµæœç”»é¢ã‚­ãƒ©ã‚­ãƒ© â”€â”€ */
    .confetti-piece {
      position: fixed; top: -20px;
      width: 12px; height: 12px;
      border-radius: 2px;
      animation: confetti-fall var(--d,3s) var(--delay,0s) linear forwards;
      pointer-events: none; z-index: 200;
    }

    /* â”€â”€ å…¥åŠ› â”€â”€ */
    .name-input {
      background: rgba(255,255,255,0.12);
      border: 3px solid var(--purple);
      border-radius: 16px; color: white;
      padding: 12px 16px; font-size: 1.3rem;
      font-family: inherit; font-weight: 700;
      text-align: center; width: 100%;
      outline: none; transition: border-color 0.2s;
    }
    .name-input:focus { border-color: var(--yellow); }

    /* â”€â”€ ãƒœã‚¿ãƒ³æ±ç”¨ â”€â”€ */
    .btn {
      border: none; cursor: pointer; font-family: inherit; font-weight: 900;
      border-radius: 20px; transition: transform 0.15s, opacity 0.15s;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(2px); }
    .btn-primary {
      background: linear-gradient(135deg, var(--pink), #c44569);
      color: white; box-shadow: 0 6px 0 #8b1a3a, 0 10px 25px rgba(255,107,157,0.35);
    }
    .btn-primary:active { box-shadow: 0 2px 0 #8b1a3a !important; }
    .btn-secondary {
      background: rgba(255,255,255,0.12);
      border: 2px solid rgba(255,255,255,0.2);
      color: white;
    }
    .btn-blue {
      background: linear-gradient(135deg, var(--mint), #0984e3);
      color: white; box-shadow: 0 6px 0 #055799, 0 10px 25px rgba(72,219,251,0.3);
    }
    .btn-yellow {
      background: linear-gradient(135deg, var(--yellow), #e67e22);
      color: #1a1a2e; box-shadow: 0 6px 0 #b7720d, 0 10px 25px rgba(255,211,42,0.3);
    }

    /* â”€â”€ ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ â”€â”€ */
    .stat-bar-bg {
      background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; height: 16px;
    }
    .stat-bar-fill {
      height: 100%; border-radius: 99px;
      background: linear-gradient(90deg, var(--mint), var(--purple));
      transition: width 1s cubic-bezier(.4,0,.2,1);
    }

    /* â”€â”€ ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ â”€â”€ */
    .logo-text {
      font-family: 'Zen Maru Gothic', sans-serif; font-weight: 900;
      background: linear-gradient(135deg, #ffd32a, #ff6b9d, #48dbfb);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* â”€â”€ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ â”€â”€ */
  .pw-screen {
    position: fixed; inset: 0; z-index: 999;
    display: flex; align-items: center; justify-content: center;
    background: radial-gradient(ellipse at 40% 40%, #1a1a3e 0%, #0d0d1e 100%);
  }
  .pw-input {
    background: rgba(255,255,255,0.1);
    border: 3px solid rgba(162,155,254,0.5);
    border-radius: 20px; color: white;
    padding: 16px 24px; font-size: 1.6rem;
    font-family: inherit; font-weight: 700;
    text-align: center; width: 100%;
    outline: none; letter-spacing: 0.3em;
    transition: border-color 0.2s;
  }
  .pw-input:focus { border-color: var(--yellow); }
  .pw-input.error { border-color: var(--pink); animation: shake 0.4s; }

  /* scrollç”¨ */
    .scroll-area { overflow-y: auto; max-height: 90vh; }
    .scroll-area::-webkit-scrollbar { width: 6px; }
    .scroll-area::-webkit-scrollbar-track { background: transparent; }
    .scroll-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 99px; }
  </style>
</head>
<body>

<!-- èƒŒæ™¯ -->
<div class="bg-canvas" id="bgCanvas"></div>

<div id="root"></div>

<script>
  // èƒŒæ™¯ã®æ˜Ÿãƒ»æ³¡ã‚’ç”Ÿæˆ
  (function() {
    const c = document.getElementById('bgCanvas');
    // æ˜Ÿ
    for (let i = 0; i < 60; i++) {
      const s = document.createElement('div');
      s.className = 'star';
      const sz = Math.random() * 3 + 1;
      s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;--delay:${Math.random()*5}s`;
      c.appendChild(s);
    }
    // æ³¡
    for (let i = 0; i < 8; i++) {
      const b = document.createElement('div');
      b.className = 'bubble';
      const sz = 30 + Math.random() * 60;
      const drift = (Math.random()-0.5)*100;
      b.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;--d:${8+Math.random()*8}s;--delay:${Math.random()*8}s;--drift:${drift}px`;
      c.appendChild(b);
    }
  })();
</script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

/* â”€â”€â”€â”€â”€ ãƒ‡ãƒ¼ã‚¿å®šç¾© â”€â”€â”€â”€â”€ */
const STORAGE_KEY = 'kokoro_busters_v2_logs';
const USERS_KEY   = 'kokoro_busters_v2_names';

const MONSTERS = [
  { id:'iraira',    name:'ã‚¤ãƒ©ã‚¤ãƒ©ã‚¶ã‚¦ãƒ«ã‚¹', emoji:'ğŸ¦–', msg:'ãŠã“ã‚Šã‚“ã¼',     power:15, color:'#ff6b9d', bg:'rgba(255,107,157,0.15)' },
  { id:'shikushiku',name:'ã‚·ã‚¯ã‚·ã‚¯ã‚´ãƒ¼ã‚¹ãƒˆ', emoji:'ğŸ‘»', msg:'ã‹ãªã—ã„',        power:10, color:'#a29bfe', bg:'rgba(162,155,254,0.15)' },
  { id:'moyamoya',  name:'ãƒ¢ãƒ¤ãƒ¢ãƒ¤ã‚¹ãƒ¢ãƒƒã‚°', emoji:'ğŸŒ«ï¸', msg:'ãµã‚ã‚“ãƒ»ã‚ã›ã‚Š',  power:12, color:'#48dbfb', bg:'rgba(72,219,251,0.15)'  },
  { id:'zukizuki',  name:'ã‚ºã‚­ã‚ºã‚­ãƒ‹ãƒ¼ãƒ‰ãƒ«', emoji:'ğŸ“', msg:'ã˜ã¶ã‚“ã‚’ã›ã‚ã‚‹',  power:18, color:'#fd79a8', bg:'rgba(253,121,168,0.15)' },
  { id:'mushimushi', name:'ãƒ ã‚·ãƒ ã‚·ãƒ»ãƒ ã‚·',   emoji:'ğŸ˜¶', msg:'ã‚€ãã‚Šã‚‡ã',      power:8,  color:'#55efc4', bg:'rgba(85,239,196,0.15)'  },
];

const COPING_CARDS = [
  { id:1, name:'ã„ãã‚’ã¯ã', emoji:'ğŸŒ¬ï¸', action:'ã‚†ã£ãã‚Š ãªãŒãƒ¼ã ã„ãã‚’ã¯ã“ã†ï¼\n3ã‹ããˆã¦ã€ã™ã£ã¦ã€‚5ã‹ããˆã¦ã€ã¯ã„ã¦ã€‚', effect:25, color:'#48dbfb' },
  { id:2, name:'ãã‚…ãƒ¼ã™ã‚‹', emoji:'ğŸ«‚',  action:'ã‹ãŸã‚’ãƒˆãƒ³ãƒˆãƒ³ã—ã¦\nã‚®ãƒ¥ãƒƒã¨ã—ã¦ã‚ã’ã¦ã­ï¼', effect:35, color:'#ff6b9d' },
  { id:3, name:'ã‹ãã ã™',   emoji:'âœï¸',  action:'ã„ã¾ã®ãã‚‚ã¡ã‚’ ç´™ã«\nãã¡ã‚ƒãã¡ã‚ƒ æã„ã¦ã¿ã‚ˆã†ï¼', effect:30, color:'#ffd32a' },
  { id:4, name:'ãŠã‚„ã™ã¿',   emoji:'ğŸ›Œ',  action:'ã‚ã‚’ã¨ã˜ã¦ 1åˆ†ã ã‘\nã‚´ãƒ­ãƒ³ã—ã‚ˆã†ã€‚', effect:40, color:'#a29bfe' },
];

const AI_TIPS = {
  'iraira':    ['æ·±å‘¼å¸ ğŸŒ¬ï¸ â€” ã‚†ã£ãã‚Šã€ãªãŒãƒ¼ã', 'ã‚¸ãƒ£ãƒ³ãƒ— ğŸƒ â€” ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ç™ºæ•£ï¼'],
  'shikushiku':['ãƒã‚° ğŸ«‚ â€” å®‰å¿ƒæ„Ÿã‚’ã‚ã‘ã¦ã‚ã’ã‚ˆã†', 'ãŠæ°´ ğŸ’§ â€” ã²ã¨ãã¡ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥'],
  'moyamoya':  ['ã€Œå¤§ä¸ˆå¤«ã€ã¨å£°ã«å‡ºã™ âœ¨', 'ã¦ã®ã²ã‚‰ã‚’ã¿ã‚‹ ğŸ‘‹ â€” ä»Šã“ã“ã«ã„ã‚‹ã‚ˆ'],
  'zukizuki':  ['ã€ŒãƒŸã‚¹ã—ã¦ã‚‚OKã€ ğŸ’› â€” è¨€ã£ã¦ã‚ã’ã‚ˆã†', 'ã‚¹ãƒã‚¤ãƒ«ç·´ç¿’ ğŸ˜Š â€” é¡”ã‹ã‚‰æ¥½ã—ã'],
  'mushimushi':['å¥½ããªéŸ³æ¥½ã‚’ã‹ã‘ã‚‹ ğŸµ', 'çª“ã‚’é–‹ã‘ã¦ç©ºã‚’è¦‹ã‚‹ â˜ï¸'],
};

/* â”€â”€â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€ */
class ReportGenerator {
  static analyze(history, user) {
    const logs = history.filter(h => h.user === user);
    if (!logs.length) return null;
    const successes = logs.filter(l => l.result === 'ã›ã„ã“ã†').length;
    const avgScore  = Math.round(logs.reduce((s,l) => s+l.score, 0) / logs.length);
    return { total: logs.length, successRate: Math.round(successes/logs.length*100), avgScore };
  }
}

/* â”€â”€â”€â”€â”€ ç´™å¹é›ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â”€â”€â”€â”€â”€ */
const Confetti = () => {
  const colors = ['#ff6b9d','#ffd32a','#48dbfb','#a29bfe','#55efc4','#ff9f43'];
  const pieces = Array.from({length:30},(_,i)=>({
    id:i,
    left:Math.random()*100,
    color:colors[Math.floor(Math.random()*colors.length)],
    d:(2+Math.random()*2).toFixed(1),
    delay:(Math.random()*1.5).toFixed(2),
    size:8+Math.random()*8,
  }));
  return <>{pieces.map(p=>(
    <div key={p.id} className="confetti-piece"
      style={{left:`${p.left}%`,background:p.color,width:p.size,height:p.size,
              '--d':`${p.d}s`,'--delay':`${p.delay}s`}}/>
  ))}</>;
};

/* â”€â”€â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª â”€â”€â”€â”€â”€ */
/* â”€â”€â”€â”€â”€ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ â”€â”€â”€â”€â”€ */
const PasswordGate = ({ onUnlock }) => {
  const [pw, setPw]       = useState('');
  const [error, setError] = useState(false);

  const check = () => {
    if (pw === 'cocoro') {
      onUnlock();
    } else {
      setError(true);
      setPw('');
      setTimeout(() => setError(false), 600);
    }
  };

  return (
    <div className="pw-screen">
      <div className="card card-glow-pink"
        style={{padding:'48px 32px',textAlign:'center',maxWidth:400,width:'100%',margin:16}}>
        <div style={{fontSize:'5rem',marginBottom:16}} className="anim-float">ğŸ”</div>
        <h2 className="logo-text" style={{fontSize:'2rem',marginBottom:8}}>ã“ã“ã‚ãƒã‚¹ã‚¿ãƒ¼ã‚º</h2>
        <p style={{color:'rgba(255,255,255,0.45)',marginBottom:28,fontSize:'0.9rem'}}>
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­
        </p>
        <input
          className={`pw-input${error?' error':''}`}
          type="password"
          value={pw}
          placeholder="â—â—â—â—â—â—"
          onChange={e => setPw(e.target.value)}
          onKeyDown={e => e.key === 'Enter' && check()}
          autoFocus
        />
        {error && (
          <p style={{color:'var(--pink)',marginTop:12,fontWeight:700,fontSize:'0.9rem'}}>
            ã¡ãŒã†ã‚ˆï¼ã‚‚ã†ã„ã¡ã© ğŸ™…
          </p>
        )}
        <button className="btn btn-primary"
          style={{width:'100%',padding:'16px',fontSize:'1.1rem',marginTop:20}}
          onClick={check}>
          ã¯ã„ã‚‹ âœ¨
        </button>
      </div>
    </div>
  );
};

const App = () => {
  const [unlocked, setUnlocked]   = useState(false);
  const [scene, setScene]         = useState('user-select');
  const [user, setUser]           = useState('');
  const [userNames, setUserNames] = useState(['ãƒãƒ', 'ã“ã©ã‚‚ï¼‘', 'ã“ã©ã‚‚ï¼’']);
  const [isEditing, setIsEditing] = useState(false);
  const [temp, setTemp]           = useState(30);
  const [monster, setMonster]     = useState(null);
  const [actionCard, setActionCard] = useState(null);
  const [stableTurns, setStableTurns] = useState(0);
  const [history, setHistory]     = useState([]);
  const [shake, setShake]         = useState(false);
  const audioCtxRef = useRef(null);

  useEffect(()=>{
    const logs  = localStorage.getItem(STORAGE_KEY);
    const names = localStorage.getItem(USERS_KEY);
    if (logs)  setHistory(JSON.parse(logs));
    if (names) setUserNames(JSON.parse(names));
  },[]);

  /* â”€â”€ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª â”€â”€ */
  const initAudio = () => {
    if (!audioCtxRef.current)
      audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
  };
  const playTone = (freq, dur, type='sine') => {
    const ctx = audioCtxRef.current; if (!ctx) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = type; osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.12, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    osc.start(); osc.stop(ctx.currentTime + dur);
  };
  const playWin = () => {
    [523,659,784,1047].forEach((f,i)=> setTimeout(()=>playTone(f,0.25),i*120));
  };

  /* â”€â”€ ã‚²ãƒ¼ãƒ çµ‚äº† â”€â”€ */
  const finishGame = useCallback((win) => {
    const log = {
      user, monster: monster.emoji, result: win ? 'ã›ã„ã“ã†' : 'ã‚„ã™ã¿',
      score: 100-temp, date: new Date().toLocaleDateString(), timestamp: Date.now()
    };
    const newHistory = [log,...history].slice(0,50);
    setHistory(newHistory);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(newHistory));
    setScene(win ? 'result-win' : 'result-lose');
    if (win) playWin(); else playTone(200,0.6,'sawtooth');
  }, [user, monster, temp, history]);

  /* â”€â”€ ã‚«ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ â”€â”€ */
  const handleAction = useCallback(() => {
    playTone(440,0.1);
    const reduced = Math.max(0, temp - actionCard.effect);
    setTemp(reduced);
    setActionCard(null);
    setTimeout(()=>{
      const next = Math.min(100, reduced + monster.power);
      setTemp(next);
      if (next >= 80) { setShake(true); setTimeout(()=>setShake(false), 500); }
      if (next <= 40) setStableTurns(s=>s+1); else setStableTurns(0);
      if (next >= 100) finishGame(false);
      else if (next <= 40 && stableTurns >= 2) finishGame(true);
    }, 1000);
  }, [temp, actionCard, monster, stableTurns, finishGame]);

  const stats = useMemo(()=> ReportGenerator.analyze(history, user), [history, user]);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (!unlocked) return <PasswordGate onUnlock={() => setUnlocked(true)} />;

  return (
    <div style={{width:'100%',maxWidth:1000,margin:'0 auto',padding:'16px',paddingBottom:32}}>

      {/* â”â”â”â” ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ â”â”â”â” */}
      {scene === 'user-select' && (
        <div className="card card-glow-pink" style={{padding:'48px 32px',textAlign:'center'}}>
          {/* ã‚¿ã‚¤ãƒˆãƒ« */}
          <div style={{marginBottom:8,fontSize:'3rem'}} className="anim-float">ğŸŒˆ</div>
          <h1 className="logo-text" style={{fontSize:'clamp(2rem,6vw,3.5rem)',margin:'0 0 8px'}}>ã“ã“ã‚ãƒã‚¹ã‚¿ãƒ¼ã‚º</h1>
          <p style={{color:'rgba(255,255,255,0.5)',marginBottom:40,fontSize:'1rem'}}>ãã‚‚ã¡ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ ãµã£ã¨ã°ãã†ï¼</p>

          <h2 style={{color:'white',fontWeight:900,fontSize:'clamp(1.4rem,4vw,2rem)',marginBottom:32}}>ã ã‚ŒãŒã‚ãã¶ï¼Ÿ</h2>

          {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒœã‚¿ãƒ³ */}
          <div style={{display:'flex',flexWrap:'wrap',gap:20,justifyContent:'center',marginBottom:32}}>
            {userNames.map((u,i)=>{
              const cls = ['user-btn-mama','user-btn-child1','user-btn-child2'][i];
              if (isEditing) return (
                <div key={i} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:8}}>
                  <input className="name-input" value={u}
                    style={{width:180}}
                    onChange={e=>{ const n=[...userNames]; n[i]=e.target.value; setUserNames(n); }}/>
                </div>
              );
              return (
                <button key={i}
                  className={`user-btn ${cls}`}
                  style={{width:180,height:100,fontSize:'1.5rem'}}
                  onClick={()=>{ initAudio(); setUser(u); setScene('start'); playTone(523,0.1); }}>
                  {u}
                </button>
              );
            })}
          </div>

          <button className="btn btn-secondary"
            style={{padding:'10px 28px',fontSize:'0.95rem'}}
            onClick={()=>{
              if (isEditing) localStorage.setItem(USERS_KEY, JSON.stringify(userNames));
              setIsEditing(v=>!v);
            }}>
            âš™ï¸ {isEditing ? 'ä¿å­˜ã™ã‚‹' : 'ãªã¾ãˆã‚’ã‹ãˆã‚‹'}
          </button>
        </div>
      )}

      {/* â”â”â”â” ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¸æŠ â”â”â”â” */}
      {scene === 'start' && (
        <div className="card" style={{padding:'32px 24px'}}>
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:28}}>
            <button className="btn btn-secondary" style={{padding:'8px 18px',fontSize:'0.9rem'}}
              onClick={()=>setScene('user-select')}>â† ã‚‚ã©ã‚‹</button>
            <div style={{color:monster?.color??'var(--mint)',fontWeight:900,fontSize:'1.1rem'}}>
              {user} ã® ã¼ã†ã‘ã‚“ âœ¨
            </div>
          </div>

          <h2 style={{color:'white',fontWeight:900,fontSize:'clamp(1.2rem,4vw,1.8rem)',
            textAlign:'center',marginBottom:24}}>
            ã©ã‚“ãª ãã‚‚ã¡ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒ ã„ã‚‹ï¼Ÿ
          </h2>

          {/* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(160px,1fr))',gap:16,marginBottom:28}}>
            {MONSTERS.map(m=>(
              <div key={m.id} className="monster-card"
                style={{padding:'24px 16px',textAlign:'center',background:m.bg,
                  borderColor:m.color+'55'}}
                onClick={()=>{
                  setMonster(m); setTemp(50); setStableTurns(0); setScene('playing');
                  playTone(392,0.15);
                }}>
                <div style={{fontSize:'4rem',marginBottom:12}} className="anim-float">{m.emoji}</div>
                <div style={{color:m.color,fontWeight:900,fontSize:'0.95rem',marginBottom:6}}>{m.name}</div>
                <div style={{color:'rgba(255,255,255,0.5)',fontSize:'0.8rem'}}>{m.msg}</div>
              </div>
            ))}
          </div>

          {/* ãƒ¬ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ */}
          <button className="btn btn-yellow"
            style={{width:'100%',padding:'16px',fontSize:'1.1rem'}}
            onClick={()=>setScene('stats')}>
            ğŸ“Š ãŒã‚“ã°ã‚Š ãƒ¬ãƒãƒ¼ãƒˆã‚’ ã¿ã‚‹
          </button>
        </div>
      )}

      {/* â”â”â”â” ãƒãƒˆãƒ«ç”»é¢ â”â”â”â” */}
      {scene === 'playing' && !actionCard && (
        <div style={{display:'grid',gridTemplateColumns:'auto 1fr',gap:16,alignItems:'start'}}>

          {/* æ¸©åº¦è¨ˆãƒ‘ãƒãƒ« */}
          <div className="card" style={{padding:'24px 16px',display:'flex',flexDirection:'column',alignItems:'center',gap:12}}>
            {/* æˆ»ã‚‹ */}
            <button className="btn btn-secondary"
              style={{padding:'6px 12px',fontSize:'0.8rem',marginBottom:4}}
              onClick={()=>{ setScene('start'); setTemp(30); }}>â† ã‚„ã‚ã‚‹</button>

            <div className={`thermo-tube ${shake?'anim-shake':''}`}>
              <div className="thermo-fill"
                style={{
                  height:`${temp}%`,
                  background: temp>70
                    ? 'linear-gradient(to top,#e74c3c,#ff6b9d)'
                    : temp>40
                      ? 'linear-gradient(to top,#f39c12,#ffd32a)'
                      : 'linear-gradient(to top,#0984e3,#48dbfb)'
                }}/>
            </div>

            <div style={{fontSize:'2rem',fontWeight:900,color:
              temp>70?'#ff6b9d':temp>40?'#ffd32a':'#48dbfb'}}>
              {temp}Â°
            </div>
            <div style={{fontSize:'0.75rem',color:'rgba(255,255,255,0.4)',textAlign:'center',maxWidth:80}}>
              {temp>=80?'ğŸ”¥ ã‚ã¶ãªã„ï¼':temp>=50?'ğŸ˜¥ ãŒã‚“ã°ã‚Œï¼':'ğŸ˜Š ã„ã„æ„Ÿã˜ï¼'}
            </div>
          </div>

          {/* ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ« */}
          <div className="card card-glow-blue" style={{padding:'24px'}}>
            {/* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ */}
            <div style={{textAlign:'center',marginBottom:20}}>
              <div style={{fontSize:'clamp(4rem,12vw,7rem)'}} className="anim-float">{monster?.emoji}</div>
              <div style={{color:monster?.color,fontWeight:900,fontSize:'1.1rem',marginTop:4}}>
                {monster?.name}
              </div>
              <div style={{color:'rgba(255,255,255,0.5)',fontSize:'0.85rem'}}>{monster?.msg}</div>
            </div>

            {/* ã‚³ãƒ¼ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:10,marginBottom:16}}>
              {COPING_CARDS.map(c=>(
                <div key={c.id} className="coping-card"
                  style={{padding:'16px 12px',textAlign:'center',borderColor:c.color+'44'}}
                  onClick={()=>{ setActionCard(c); playTone(523,0.1); }}>
                  <div style={{fontSize:'2.2rem',marginBottom:6}}>{c.emoji}</div>
                  <div style={{color:'white',fontWeight:900,fontSize:'0.85rem'}}>{c.name}</div>
                  <div style={{color:c.color,fontSize:'0.75rem',marginTop:4}}>âˆ’{c.effect}Â°</div>
                </div>
              ))}
            </div>

            {/* AIãƒ’ãƒ³ãƒˆ */}
            {monster && (
              <div className="ai-bubble">
                <div style={{color:'var(--purple)',fontWeight:900,fontSize:'0.9rem',marginBottom:8}}>
                  ğŸ¤– AIãŠãŸã™ã‘éšŠã®ãƒ’ãƒ³ãƒˆ
                </div>
                {(AI_TIPS[monster.id]||[]).map((t,i)=>(
                  <div key={i} style={{color:'rgba(255,255,255,0.75)',fontSize:'0.83rem',marginBottom:4}}>
                    ãƒ»{t}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* â”â”â”â” ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å…¨ç”»é¢ â”â”â”â” */}
      {actionCard && (
        <div className="action-overlay">
          <div className="card" style={{
            padding:'40px 28px',maxWidth:500,width:'100%',textAlign:'center',
            border:`3px solid ${actionCard.color}88`,
            boxShadow:`0 0 60px ${actionCard.color}44, 0 30px 80px rgba(0,0,0,0.6)`
          }}>
            <div style={{fontSize:'6rem',marginBottom:16}} className="anim-float anim-pop">
              {actionCard.emoji}
            </div>
            <h2 style={{color:'white',fontWeight:900,fontSize:'clamp(1.3rem,4vw,2rem)',
              lineHeight:1.5,marginBottom:32,whiteSpace:'pre-line'}}>
              {actionCard.action}
            </h2>
            <button className="btn btn-primary"
              style={{width:'100%',padding:'20px',fontSize:'1.4rem'}}
              onClick={handleAction}>
              ã§ããŸï¼ âœ¨
            </button>
          </div>
        </div>
      )}

      {/* â”â”â”â” çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ â”â”â”â” */}
      {scene === 'stats' && (
        <div className="card card-glow-yellow scroll-area" style={{padding:'32px 24px'}}>
          <h2 style={{color:'white',fontWeight:900,fontSize:'clamp(1.3rem,4vw,2rem)',
            textAlign:'center',marginBottom:24}}>
            ğŸ“ˆ {user} ã® æˆé•·ãƒ¬ãƒãƒ¼ãƒˆ
          </h2>

          {stats ? (
            <>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14,marginBottom:24}}>
                {[
                  {label:'ã›ã„ã“ã†ç‡',val:`${stats.successRate}%`,color:'var(--mint)'},
                  {label:'ãƒãƒ£ãƒ¬ãƒ³ã‚¸å›æ•°',val:`${stats.total}å›`,color:'var(--yellow)'},
                  {label:'å¹³å‡ã‚¹ã‚³ã‚¢',val:`${stats.avgScore}ç‚¹`,color:'var(--purple)'},
                ].map(s=>(
                  <div key={s.label} className="card"
                    style={{padding:'20px',textAlign:'center',borderColor:s.color+'44'}}>
                    <div style={{color:'rgba(255,255,255,0.5)',fontSize:'0.85rem',marginBottom:8}}>{s.label}</div>
                    <div style={{color:s.color,fontWeight:900,fontSize:'2rem'}}>{s.val}</div>
                  </div>
                ))}
              </div>

              {/* æˆåŠŸç‡ãƒãƒ¼ */}
              <div style={{marginBottom:24}}>
                <div style={{color:'rgba(255,255,255,0.6)',fontSize:'0.85rem',marginBottom:8}}>
                  ã›ã„ã“ã†ç‡ â€” {stats.successRate}%
                </div>
                <div className="stat-bar-bg">
                  <div className="stat-bar-fill" style={{width:`${stats.successRate}%`}}/>
                </div>
              </div>

              {/* æœ€è¿‘ã®è¨˜éŒ² */}
              <div style={{marginBottom:24}}>
                <div style={{color:'rgba(255,255,255,0.5)',fontSize:'0.85rem',marginBottom:10}}>æœ€è¿‘ã®ãã‚ã</div>
                {history.filter(h=>h.user===user).slice(0,5).map((h,i)=>(
                  <div key={i} className="card"
                    style={{padding:'12px 16px',marginBottom:8,
                      display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span style={{fontSize:'1.4rem'}}>{h.monster}</span>
                    <span style={{color:h.result==='ã›ã„ã“ã†'?'var(--mint)':'var(--pink)',
                      fontWeight:700,fontSize:'0.9rem'}}>{h.result}</span>
                    <span style={{color:'rgba(255,255,255,0.4)',fontSize:'0.8rem'}}>{h.date}</span>
                    <span style={{color:'var(--yellow)',fontWeight:900}}>{h.score}ç‚¹</span>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <p style={{color:'rgba(255,255,255,0.4)',textAlign:'center',marginBottom:32,fontSize:'1rem'}}>
              ã¾ã ãã‚ããŒãªã„ã‚ˆï¼<br/>ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ ãƒ¬ãƒãƒ¼ãƒˆã‚’ ä½œã‚ã†ï¼
            </p>
          )}

          <div style={{display:'flex',gap:12}}>
            <button className="btn btn-secondary"
              style={{flex:1,padding:'14px',fontSize:'1rem'}}
              onClick={()=>setScene('start')}>â† ã‚‚ã©ã‚‹</button>
            {stats && (
              <button className="btn btn-blue"
                style={{flex:1,padding:'14px',fontSize:'1rem'}}
                onClick={()=>{
                  const logs = history.filter(h=>h.user===user);
                  const csv  = ['æ—¥ä»˜,ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼,çµæœ,ã‚¹ã‚³ã‚¢',
                    ...logs.map(l=>`${l.date},${l.monster},${l.result},${l.score}`)].join('\n');
                  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
                  const a = document.createElement('a');
                  a.href = URL.createObjectURL(blob);
                  a.download = `${user}_ã“ã“ã‚ã®ãã‚ã.csv`; a.click();
                }}>
                ğŸ“¥ CSVã§å‡ºã™
              </button>
            )}
          </div>
        </div>
      )}

      {/* â”â”â”â” çµæœï¼šã‚¯ãƒªã‚¢ â”â”â”â” */}
      {scene === 'result-win' && (
        <>
          <Confetti/>
          <div className="card card-glow-yellow" style={{padding:'48px 32px',textAlign:'center',
            maxWidth:480,margin:'0 auto'}}>
            <div style={{fontSize:'6rem',marginBottom:16}} className="anim-float">ğŸ†</div>
            <h2 className="logo-text" style={{fontSize:'clamp(2.5rem,8vw,4rem)',marginBottom:8}}>
              ã‚¯ãƒªã‚¢ï¼
            </h2>
            <p style={{color:'rgba(255,255,255,0.6)',marginBottom:32,fontSize:'1rem'}}>
              {user}ã€ã‚ˆãã§ããŸã­ï¼<br/>ã‚¹ã‚³ã‚¢: <b style={{color:'var(--yellow)'}}>{100-temp}ç‚¹</b>
            </p>
            <button className="btn btn-primary"
              style={{width:'100%',padding:'16px',fontSize:'1.1rem'}}
              onClick={()=>setScene('start')}>
              ğŸ® ã‚‚ã†ã„ã¡ã©
            </button>
          </div>
        </>
      )}

      {/* â”â”â”â” çµæœï¼šãŠã‚„ã™ã¿ â”â”â”â” */}
      {scene === 'result-lose' && (
        <div className="card card-glow-pink" style={{padding:'48px 32px',textAlign:'center',
          maxWidth:480,margin:'0 auto'}}>
          <div style={{fontSize:'6rem',marginBottom:16}} className="anim-float">ğŸŒ™</div>
          <h2 style={{color:'var(--mint)',fontWeight:900,fontSize:'clamp(2rem,6vw,3rem)',marginBottom:8}}>
            ã‚„ã™ã‚‚ã†
          </h2>
          <p style={{color:'rgba(255,255,255,0.6)',marginBottom:32,fontSize:'1rem'}}>
            ãã‚‡ã†ã¯ã‚ˆããŒã‚“ã°ã£ãŸã‚ˆï¼<br/>ã¤ã‹ã‚ŒãŸã¨ãã¯ ã‚†ã£ãã‚Šä¼‘ã‚‚ã†ã­ã€‚
          </p>
          <button className="btn btn-secondary"
            style={{width:'100%',padding:'16px',fontSize:'1.1rem'}}
            onClick={()=>setScene('start')}>
            ğŸ  ã‚‚ã©ã‚‹
          </button>
        </div>
      )}

    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
